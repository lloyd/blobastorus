<script type="text/javascript" src="jschannel-min.js"></script>
<script type="text/javascript">

// wrap browser diffs
if (!window.XMLHttpRequest) {
    window.XMLHttpRequest = function () {
        return new ActiveXObject("Microsoft.XMLHTTP");
    }
}
XHR = window.XMLHttpRequest;

// a function to clean up origin
function cleanOrigin(o) {
    if (o === null) return 'local';
    return o.replace(/^[a-z]+:\/\//, "");
}

var chan = Channel.build({window: window.parent, origin: "*", scope: "blobastorus"});

chan.bind("get", function(trans, args) {
    // we will be async
    trans.delayReturn(true);

    var origin = cleanOrigin(trans.origin);
    var url = "/api/get/" + origin + "/" + "XXXX";

    var r = new XHR();
    r.open('GET', url, true);

    r.onreadystatechange = function (e) { 
        if (r.readyState == 4) {
            e.preventDefault();
            if (r.status == 200) {
                trans.complete(JSON.parse(r.responseText));
            } else if (r.status == 404) {
                trans.complete(null);
            } else {
                trans.error("networkError", "Error loading page\n");
            }
        }
    };
    r.send(null);
});

chan.bind("set", function(trans, args) {
    // we will be async
    trans.delayReturn(true);

    var origin = cleanOrigin(trans.origin);
    var url = "/api/set/" + origin + "/" + "XXXX";

    var r = new XHR();
    r.open('POST', url, true);
    r.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

    r.onreadystatechange = function (e) {
        if (r.readyState == 4) {
            e.preventDefault();
            if (r.status == 200) {
                trans.complete(true);
            } else {
                trans.complete(false);
            }
        }
    };
    r.send("data=" + JSON.stringify(args));
});

chan.bind("isLoggedIn", function(trans, args) {
    // being logged in signifies that the users twitter username and secret
    // is set in local storage.
    var sto = window.localStorage;

    // Expire secrets after 2 weeks (?).
    var ts = sto.getItem("ts")
    if (typeof ts === 'string') {
        var ts = new Date(sto.getItem("ts"));
        if (((new Date() - ts) / 1000.0) > (14 * 24 * 60 * 60)) sto.clear();
    }

    var user = sto.getItem("user");
    var secret = sto.getItem("secret");
    
    if (user && secret) {
        return true;
    } else {
        // XXX: http*S*
        return "http://localhost:3000/auth/?kickback=" + args;
    }
});

</script>
